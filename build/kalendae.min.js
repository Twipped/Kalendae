/********************************************************************
 *	Kalendae, a framework agnostic javascript date picker           *
 *	Copyright(c) 2013 Jarvis Badgley (chipersoft@gmail.com)         *
 *	http://github.com/ChiperSoft/Kalendae                           *
 *	Version 0.4.2                                                   *
 ********************************************************************/

(function(y){var r,h,m=function(a,b){if("function"===typeof document.addEventListener||d.isIE8()){var c=!1;try{c=a instanceof Element}catch(k){c=!!a&&1===c.nodeType}c||"string"===typeof a||(b=a);var e=this,f=e.classes,g=e.settings=d.merge(e.defaults,{attachTo:a},b||{}),c=e.container=d.make("div",{"class":f.container}),m=e.calendars=[],p=h().day(g.weekStart),q,s=[],l,n,r,t;l=[];var v;n=0;q=g.months;d.isIE8()&&d.addClassName(c,"ie8");for(n=7;n--;)s.push(p.format(g.columnHeaderFormat)),p.add("days",
1);x(e);if("object"===typeof g.subscribe)for(n in g.subscribe)g.subscribe.hasOwnProperty(n)&&e.subscribe(n,g.subscribe[n]);e._sel=[];g.selected&&e.setSelected(g.selected,!1);q=g.viewStartDate?h(g.viewStartDate,g.format):0<e._sel.length?h(e._sel[0]):h();e.viewStartDate=q.date(1);(q={past:g.months-1,"today-past":g.months-1,any:2<g.months?Math.floor(g.months/2):0,"today-future":0,future:0}[this.settings.direction])&&h().month()==h(e.viewStartDate).month()&&(e.viewStartDate=h(e.viewStartDate).subtract({M:q}).date(1));
if("function"===typeof g.blackout)e.blackout=g.blackout;else if(g.blackout){var w=u(g.blackout,g.parseSplitDelimiter,g.format);e.blackout=function(a){a=h(a).yearDay();if(1>a||!e._sel)return!1;for(var c=w.length;c--;)if(w[c].yearDay()===a)return!0;return!1}}else e.blackout=function(){return!1};e.direction=e.directions[g.direction]?e.directions[g.direction]:e.directions.any;for(q=Math.max(g.months,1);q--;){l=d.make("div",{"class":f.calendar},c);l.setAttribute("data-cal-index",q);1<g.months&&(q==Math.max(g.months-
1,1)?d.addClassName(l,f.monthFirst):0===q?d.addClassName(l,f.monthLast):d.addClassName(l,f.monthMiddle));n=d.make("div",{"class":f.title},l);g.useYearNav||d.addClassName(n,f.disableYearNav);d.make("a",{"class":f.previousYear},n);d.make("a",{"class":f.previousMonth},n);d.make("a",{"class":f.nextYear},n);d.make("a",{"class":f.nextMonth},n);p=d.make("span",{"class":f.caption},n);r=d.make("div",{"class":f.header},l);n=0;do v=d.make("span",{},r),v.innerHTML=s[n];while(7>++n);r=d.make("div",{"class":f.days},
l);n=0;l=[];do"week"==g.mode?(0==n%7&&(t=d.make("div",{"class":f.week+" clearfix"},r),l.push(t)),d.make("span",{},t)):l.push(d.make("span",{},r));while(42>++n);m.push({caption:p,days:l});q&&d.make("div",{"class":f.monthSeparator},c)}e.draw();d.addEvent(c,"mousedown",function(a,c){var b;if(d.hasClassName(c,f.nextMonth))e.disableNext||!1===e.publish("view-changed",e,["next-month"])||(e.viewStartDate.add("months",1),e.draw());else if(d.hasClassName(c,f.previousMonth))e.disablePreviousMonth||!1===e.publish("view-changed",
e,["previous-month"])||(e.viewStartDate.subtract("months",1),e.draw());else if(d.hasClassName(c,f.nextYear))e.disableNext||!1===e.publish("view-changed",e,["next-year"])||(e.viewStartDate.add("years",1),e.draw());else if(d.hasClassName(c,f.previousYear))e.disablePreviousMonth||!1===e.publish("view-changed",e,["previous-year"])||(e.viewStartDate.subtract("years",1),e.draw());else if((d.hasClassName(c.parentNode,f.days)||d.hasClassName(c.parentNode,f.week))&&d.hasClassName(c,f.dayActive)&&(b=c.getAttribute("data-date"))){if(b=
h(b,g.dayAttributeFormat).hours(12),!1!==e.publish("date-clicked",e,[b]))switch(g.mode){case "multiple":e.addSelected(b)||e.removeSelected(b);break;case "range":e.addSelected(b);break;case "week":e.weekSelected(b);break;default:e.addSelected(b)}}else d.hasClassName(c.parentNode,f.week)&&(b=c.getAttribute("data-date"))&&(b=h(b,g.dayAttributeFormat).hours(12),!1!==e.publish("date-clicked",e,[b])&&"week"==g.mode&&e.weekSelected(b));return!1});(g.attachTo=d.$(g.attachTo))&&g.attachTo.appendChild(c)}};
m.prototype={defaults:{attachTo:null,months:1,weekStart:0,direction:"any",directionScrolling:!0,viewStartDate:null,blackout:null,selected:null,mode:"single",dayOutOfMonthClickable:!1,format:null,subscribe:null,columnHeaderFormat:"dd",titleFormat:"MMMM, YYYY",dayNumberFormat:"D",dayAttributeFormat:"YYYY-MM-DD",parseSplitDelimiter:/,\s*|\s+-\s+/,rangeDelimiter:" - ",multipleDelimiter:", ",useYearNav:!0,dateClassMap:{}},classes:{container:"kalendae",calendar:"k-calendar",monthFirst:"k-first-month",monthMiddle:"k-middle-month",
monthLast:"k-last-month",title:"k-title",previousMonth:"k-btn-previous-month",nextMonth:"k-btn-next-month",previousYear:"k-btn-previous-year",nextYear:"k-btn-next-year",caption:"k-caption",header:"k-header",days:"k-days",week:"k-week",dayOutOfMonth:"k-out-of-month",dayInMonth:"k-in-month",dayActive:"k-active",daySelected:"k-selected",dayInRange:"k-range",dayToday:"k-today",monthSeparator:"k-separator",disablePreviousMonth:"k-disable-previous-month-btn",disableNextMonth:"k-disable-next-month-btn",
disablePreviousYear:"k-disable-previous-year-btn",disableNextYear:"k-disable-next-year-btn",disableYearNav:"k-disable-year-nav"},disablePreviousMonth:!1,disableNextMonth:!1,disablePreviousYear:!1,disableNextYear:!1,directions:{past:function(a){return h(a).yearDay()>=r.yearDay()},"today-past":function(a){return h(a).yearDay()>r.yearDay()},any:function(a){return!1},"today-future":function(a){return h(a).yearDay()<r.yearDay()},future:function(a){return h(a).yearDay()<=r.yearDay()}},getSelectedAsDates:function(){for(var a=
[],b=0,c=this._sel.length;b<c;b++)a.push(this._sel[b].toDate());return a},getSelectedAsText:function(a){for(var b=[],c=0,d=this._sel.length;c<d;c++)b.push(this._sel[c].format(a||this.settings.format||"YYYY-MM-DD"));return b},getSelectedRaw:function(){for(var a=[],b=0,c=this._sel.length;b<c;b++)a.push(h(this._sel[b]));return a},getSelected:function(a){a=this.getSelectedAsText(a);switch(this.settings.mode){case "week":case "range":return a.splice(2),a.join(this.settings.rangeDelimiter);case "multiple":return a.join(this.settings.multipleDelimiter);
default:return a[0]||null}},isSelected:function(a){a=h(a).yearDay();if(1>a||!this._sel||1>this._sel.length)return!1;switch(this.settings.mode){case "week":case "range":var b=this._sel[0]?this._sel[0].yearDay():0,c=this._sel[1]?this._sel[1].yearDay():0;return b===a||c===a?1:b&&c?a>b&&a<c||b<c&&a<b&&a>c?-1:!1:0;case "multiple":for(b=this._sel.length;b--;)if(this._sel[b].yearDay()===a)return!0;return!1;default:return this._sel[0]&&this._sel[0].yearDay()===a}},setSelected:function(a,b){var c,d=u(a,this.settings.parseSplitDelimiter,
this.settings.format),e=u(this.getSelected(),this.settings.parseSplitDelimiter,this.settings.format);for(c=e.length;c--;)this.removeSelected(e[c],!1);for(c=d.length;c--;)this.addSelected(d[c],!1);!1!==b&&(d[0]&&(this.viewStartDate=h(d[0],this.settings.format)),this.draw())},addSelected:function(a,b){a=h(a,this.settings.format).hours(12);this.settings.dayOutOfMonthClickable&&"range"!==this.settings.mode&&this.makeSelectedDateVisible(a);switch(this.settings.mode){case "multiple":if(this.isSelected(a))return!1;
this._sel.push(a);break;case "range":1!==this._sel.length?this._sel=[a]:a.yearDay()>this._sel[0].yearDay()?this._sel[1]=a:this._sel=[a,this._sel[0]];break;default:this._sel=[a]}this._sel.sort(function(a,b){return a.yearDay()-b.yearDay()});this.publish("change",this,[a]);!1!==b&&this.draw();return!0},weekSelected:function(a){var b=a.toDate(),c=h(b).startOf("week"),b=h(b).endOf("week").subtract("day",1);this._sel=[c,b];this.publish("change",this,[a.day()]);this.draw()},makeSelectedDateVisible:function(a){outOfViewMonth=
h(a).date("1").diff(this.viewStartDate,"months");0>outOfViewMonth?this.viewStartDate.subtract("months",1):0<outOfViewMonth&&outOfViewMonth>=this.settings.months&&this.viewStartDate.add("months",1)},removeSelected:function(a,b){a=h(a,this.settings.format).hours(12);for(var c=this._sel.length;c--;)if(this._sel[c].yearDay()===a.yearDay())return this._sel.splice(c,1),this.publish("change",this,[a]),!1!==b&&this.draw(),!0;return!1},draw:function(){var a=h(this.viewStartDate).startOf("day").hours(12),b,
c=this.classes,k,e,f,g=0,m,p=0,q,s,l=this.settings;m=this.calendars.length;do{b=h(a).date(1);b.day(b.day()<this.settings.weekStart?this.settings.weekStart-7:this.settings.weekStart);k=this.calendars[g];k.caption.innerHTML=a.format(this.settings.titleFormat);q=p=0;do"week"==l.mode?(0==p%7&&0!=p&&q++,e=k.days[q].childNodes[p%7]):e=k.days[p],f=[],(s=this.isSelected(b))&&f.push({"-1":c.dayInRange,1:c.daySelected,"true":c.daySelected}[s]),b.month()!=a.month()?f.push(c.dayOutOfMonth):f.push(c.dayInMonth),
(!(this.blackout(b)||this.direction(b)||b.month()!=a.month()&&!1===l.dayOutOfMonthClickable)||0<s)&&f.push(c.dayActive),b.yearDay()===r.yearDay()&&f.push(c.dayToday),s=b.format(this.settings.dayAttributeFormat),l.dateClassMap[s]&&f.push(l.dateClassMap[s]),e.innerHTML=b.format(l.dayNumberFormat),e.className=f.join(" "),e.setAttribute("data-date",s),b.add("days",1);while(42>++p);a.add("months",1)}while(++g<m);if(l.directionScrolling){b=h().startOf("day").hours(12);a=a.diff(b,"months",!0);if("today-past"===
l.direction||"past"===l.direction)0>=a?(this.disableNextMonth=!1,d.removeClassName(this.container,c.disableNextMonth)):(this.disableNextMonth=!0,d.addClassName(this.container,c.disableNextMonth));else if("today-future"===l.direction||"future"===l.direction)a>l.months?(this.disablePreviousMonth=!1,d.removeClassName(this.container,c.disablePreviousMonth)):(this.disablePreviousMonth=!0,d.addClassName(this.container,c.disablePreviousMonth));if("today-past"===l.direction||"past"===l.direction)-11>=a?(this.disableNextYear=
!1,d.removeClassName(this.container,c.disableNextYear)):(this.disableNextYear=!0,d.addClassName(this.container,c.disableNextYear));else if("today-future"===l.direction||"future"===l.direction)a>11+l.months?(this.disablePreviousYear=!1,d.removeClassName(this.container,c.disablePreviousYear)):(this.disablePreviousYear=!0,d.addClassName(this.container,c.disablePreviousYear))}}};var u=function(a,b,c){var k=[];"string"===typeof a?a=a.split(b):d.isArray(a)||(a=[a]);b=a.length;var e=0;do a[e]&&k.push(h(a[e],
c).hours(12));while(++e<b);return k};window.Kalendae=m;var d=m.util={isIE8:function(){return!(!/msie 8./i.test(navigator.appVersion)||/opera/i.test(navigator.userAgent)||!window.ActiveXObject||!XDomainRequest||window.msPerformance)},$:function(a){return"string"==typeof a?document.getElementById(a):a},$$:function(a){return document.querySelectorAll(a)},make:function(a,b,c){var d;a=document.createElement(a);if(b)for(d in b)b.hasOwnProperty(d)&&a.setAttribute(d,b[d]);c&&c.appendChild(a);return a},isVisible:function(a){return 0<
a.offsetWidth||0<a.offsetHeight},getStyle:function(a,b){var c;a.currentStyle?c=a.currentStyle[b]:window.getComputedStyle&&(c=(c=window.getComputedStyle(a,null))?c[b]:"");return c},domReady:function(a){var b=document.readyState;"complete"===b||"interactive"===b?a():setTimeout(function(){d.domReady(a)},9)},addEvent:function(a,b,c){var d=function(b){b=b||window.event;var d=c.apply(a,[b,b.target||b.srcElement]);!1===d&&(b.preventDefault?b.preventDefault():(b.returnValue=!1,b.cancelBubble=!0));return d};
a.attachEvent?a.attachEvent("on"+b,d):a.addEventListener(b,d,!1);return d},removeEvent:function(a,b,c){a.detachEvent?a.detachEvent("on"+b,c):a.removeEventListener(b,c,!1)},hasClassName:function(a,b){if(!(a=d.$(a)))return!1;var c=a.className;return 0<c.length&&(c==b||RegExp("(^|\\s)"+b+"(\\s|$)").test(c))},addClassName:function(a,b){(a=d.$(a))&&!d.hasClassName(a,b)&&(a.className+=(a.className?" ":"")+b)},removeClassName:function(a,b){if(a=d.$(a))a.className=d.trimString(a.className.replace(RegExp("(^|\\s+)"+
b+"(\\s+|$)")," "))},isFixed:function(a){do if("fixed"===d.getStyle(a,"position"))return!0;while(a=a.offsetParent);return!1},scrollContainer:function(a){do{var b=d.getStyle(a,"overflow");if("auto"===b||"scroll"===b)return a}while((a=a.parentNode)&&a!=window.document.body);return null},getPosition:function(a,b){var c=a.offsetLeft,d=a.offsetTop,e={};if(!b)for(;a=a.offsetParent;)c+=a.offsetLeft,d+=a.offsetTop;e[0]=e.left=c;e[1]=e.top=d;return e},getHeight:function(a){return a.offsetHeight||a.scrollHeight},
getWidth:function(a){return a.offsetWidth||a.scrollWidth},trimString:function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},merge:function(){for(var a=!0===arguments[0],b={},c=a?1:0;c<arguments.length;c++){var d=b,e=arguments[c];if("object"===typeof e){var f=void 0;for(f in e)e.hasOwnProperty(f)&&(a&&"object"===typeof d[f]&&"object"===typeof e[f]?_update(d[f],e[f]):d[f]=e[f])}}return b},isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a)}};"function"===typeof document.addEventListener&&
m.util.domReady(function(){for(var a=d.$$(".auto-kal"),b=a.length,c,k;b--;)c=a[b],k=c.getAttribute("data-kal"),k=null==k||""==k?{}:(new Function("return {"+k+"};"))(),"INPUT"===c.tagName?new m.Input(c,k):new m(d.merge(k,{attachTo:c}))});m.Input=function(a,b){if("function"===typeof document.addEventListener||d.isIE8()){var c=this.input=d.$(a),k,e,f=!1;if(!c||"INPUT"!==c.tagName)throw"First argument for Kalendae.Input must be an <input> element or a valid element id.";var g=this,h=g.classes;e=g.settings=
d.merge(g.defaults,b);this._events={};e.attachTo=window.document.body;e.selected?k=!0:e.selected=c.value;m.call(g,e);e.closeButton&&(e=d.make("a",{"class":h.closeButton},g.container),d.addEvent(e,"click",function(){c.blur()}));k&&(c.value=g.getSelected());k=g.container;var p=!1;k.style.display="none";d.addClassName(k,h.positioned);this._events.containerMouseDown=d.addEvent(k,"mousedown",function(a,c){p=!0});this._events.documentMousedown=d.addEvent(window.document,"mousedown",function(a,c){p=!1});
this._events.inputFocus=d.addEvent(c,"focus",function(){f=!0;g.setSelected(this.value);f=!1;g.show()});this._events.inputBlur=d.addEvent(c,"blur",function(){p&&d.isIE8()?(p=!1,c.focus()):g.hide()});this._events.inputKeyup=d.addEvent(c,"keyup",function(a){f=!0;g.setSelected(this.value);f=!1});(h=d.scrollContainer(c))&&d.addEvent(h,"scroll",function(a){c.blur()});g.subscribe("change",function(){f||(c.value=g.getSelected())})}};m.Input.prototype=d.merge(m.prototype,{defaults:d.merge(m.prototype.defaults,
{format:"MM/DD/YYYY",side:"bottom",closeButton:!0,offsetLeft:0,offsetTop:0}),classes:d.merge(m.prototype.classes,{positioned:"k-floating",closeButton:"k-btn-close"}),show:function(){var a=this.container,b=a.style,c=this.input,k=d.getPosition(c),e=d.scrollContainer(c),e=e?e.scrollTop:0,f=this.settings;b.display="";switch(f.side){case "left":b.left=k.left-d.getWidth(a)+f.offsetLeft+"px";b.top=k.top+f.offsetTop-e+"px";break;case "right":b.left=k.left+d.getWidth(c)+"px";b.top=k.top+f.offsetTop-e+"px";
break;case "top":b.left=k.left+f.offsetLeft+"px";b.top=k.top-d.getHeight(a)+f.offsetTop-e+"px";break;default:b.left=k.left+f.offsetLeft+"px",b.top=k.top+d.getHeight(c)+f.offsetTop-e+"px"}b.position=d.isFixed(c)?"fixed":"absolute";this.publish("show",this)},hide:function(){this.container.style.display="none";this.publish("hide",this)},destroy:function(){var a=this.input;d.removeEvent(this.container,"mousedown",this._events.containerMousedown);d.removeEvent(window.document,"mousedown",this._events.documentMousedown);
d.removeEvent(a,"focus",this._events.inputFocus);d.removeEvent(a,"blur",this._events.inputBlur);d.removeEvent(a,"keyup",this._events.inputKeyup)}});var x=function(a){a||(a=this);var b=a.c_||{};a.publish=function(a,d,e){for(var f=(a=b[a])?a.length:0,g;f--;)if(g=a[f].apply(d,e||[]),"boolean"===typeof g)return g};a.subscribe=function(a,d,e){b[a]||(b[a]=[]);e?b[a].push(d):b[a].unshift(d);return[a,d]};a.unsubscribe=function(a){var d=b[a[0]];a=a[1];for(var e=d?d.length:0;e--;)d[e]===a&&d.splice(e,1)}};
if(!m.moment)if(window.moment)m.moment=window.moment;else throw"Kalendae requires moment.js. You must use kalendae.standalone.js if moment is not available on the page.";h=m.moment;h.fn.stripTime=function(){this._d=new Date(864E5*Math.floor(this._d.valueOf()/864E5));return this};h.fn.yearDay=function(a){var b=Math.floor(this._d/864E5);return"undefined"===typeof a?b:this.add({d:a-b})};r=m.moment().stripTime();"undefined"===typeof jQuery||"function"!==typeof document.addEventListener&&!d.isIE8()||(jQuery.fn.kalendae=
function(a){this.each(function(b,c){"INPUT"===c.tagName?$(c).data("kalendae",new m.Input(c,a)):$(c).data("kalendae",new m($.extend({},{attachTo:c},a)))});return this})})();
